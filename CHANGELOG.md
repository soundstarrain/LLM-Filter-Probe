# 更新日志

本项目的所有重要变更将在此记录。

---

## 1.2.0 (2025-12-09)

### 🚀 新功能

- **等长延迟掩码机制**：实现了全新的掩码策略，在并发扫描过程中动态应用已知敏感词的掩码
  - 等长替换：敏感词替换为相同长度的 `*`，保持文本长度不变，坐标系始终一致
  - 延迟绑定：在获取信号量后、发送请求前应用掩码，充分利用前面任务的发现结果
  - 完全掩码优化：若掩码后文本为空，直接跳过 API 请求
  - 性能提升：在并发 15 的场景下，整体 API 调用减少 **40-60%**

- **检验流程三阶段算法**：引入全新的结果精炼流程，显著提升扫描精度
  - 验证阶段：对所有候选片段进行 API 再次验证，过滤掉"幻觉长句"
  - 精炼阶段：处理候选片段中的包含关系，提取最终的核心关键词
  - 清点阶段：用核心关键词重新进行全局搜索，得到最准确的位置和数量
  - 整体过滤率：通常 **70-90%**，最终结果更加准确可靠

- **全局掩码管理器**：新增 `GlobalMaskManager` 类，集中管理已知敏感词列表
  - 线程安全：使用 RLock 保护共享数据结构
  - 快照机制：获取敏感词列表时返回副本，避免并发修改
  - 统计信息：提供掩码统计接口，便于监控和调试

- **配置定义统一**：新增 `ConfigDefinitions` 类，集中管理所有配置相关的定义
  - 字段分类：凭证、设置、规则三大类
  - 验证规则：统一的字段验证逻辑，消除重复代码
  - 类型转换：集中管理类型转换规则
  - 默认值管理：统一的默认值定义

- **结构化日志工具**：新增 `StructuredLogger` 类，提供统一的日志记录接口
  - 阶段日志：为检验流程各阶段提供专用日志方法
  - 统计日志：记录关键词发现、验证完成等重要事件
  - 格式统一：消除日志格式不一致的问题

- **未知状态码统计**：在扫描完成时统计并报告所有遇到的未知状态码
  - 出现次数统计：记录每个未知状态码出现的次数
  - 处理建议：为不同类型的状态码提供配置建议
  - 前端展示：在结果页面显示未知状态码统计信息

- **敏感词判断依据记录**：记录每个敏感词的判断依据（基于哪个关键词或状态码）
  - 证据链追踪：记录敏感词的发现时间和上下文
  - 前端展示：在结果页面显示敏感词的判断依据

### ✨ 优化与改进

#### 后端优化

- **并发处理增强**：使用 `asyncio.Semaphore` 实现真正的并发控制
  - 支持用户中止扫描
  - 实时进度更新和结果反馈
  - 完整的异常处理和错误恢复

- **网络异常处理**：集成 `tenacity` 库，实现强力重试机制
  - 支持多种网络异常的自动重试
  - 指数退避策略，最多重试 5 次
  - 网络异常不再被当作 SAFE 处理

- **长结果清洗**：新增长结果清洗逻辑，改进低精度长句的处理
  - 对长度超过 10 的结果进行清洗
  - 尝试在结果中找到更精确的敏感词
  - 严格遵循全局坐标原则，避免坐标转换错误

- **验证阶段优化**：在验证阶段跳过动态掩码，确保裸词被正确验证
  - 避免已发现的敏感词被掩码成 `*` 后被误判为 SAFE
  - 提高验证阶段的准确性

#### 前端优化

- **搜索功能**：在结果页面添加敏感词搜索功能
  - 快速查找特定敏感词
  - 实时过滤结果列表

- **分页功能**：完整的分页支持
  - 支持自定义每页条数（10/20/50/100）
  - 自动计算全局序号
  - 搜索时自动重置到第一页

- **位置展示优化**：将位置列改为网格卡片布局
  - 更美观的展示效果
  - 更好的可读性
  - 优化的滚动条样式

- **统计信息展示**：新增未知状态码统计和敏感词判断依据的展示
  - 黄色警告区域显示未知状态码
  - 蓝色信息区域显示敏感词判断依据
  - 清晰的分类和标签

- **进度节流**：限制进度更新频率，减少前端卡顿
  - 每秒最多 5 次进度更新
  - 小文本总是发送完整进度
  - 结果缓冲机制，批量发送

- **页面刷新处理**：检测页面刷新，自动清空日志
  - 避免日志混乱
  - 更清晰的日志界面

#### 代码质量

- **代码重构**：消除重复代码，提高代码质量
  - 删除重复的方法定义
  - 统一配置管理逻辑
  - 优化日志输出

- **注释规范**：统一注释风格，提高代码可读性
  - 统一使用中文注释
  - 只注释"为什么"，不注释"是什么"
  - 避免重复注释

- **模块化改进**：减少模块耦合度
  - 配置管理层功能重叠消除
  - 日志记录逻辑集中管理
  - 掩码管理独立为单独模块

###  Bug 修复

- **重复代码删除**：删除 `text_scanner.py` 中重复的 `reset_masking()` 调用
- **坐标转换修复**：修复 `PrecisionScanner` 中的坐标转换错误，严格遵循全局坐标原则
- **网络异常处理**：网络异常不再被当作 SAFE 处理，异常时重新抛出让上层处理
- **日志重复问题**：移除初始化日志，避免与 `scan_started` 中的日志重复
- **配置预设同步**：切换预设时自动更新规则数据，确保预设和规则数据的一致性
- **结果合并修复**：进度更新时合并结果而不是替换，避免数据丢失

---

## 1.1.0 (2025-12-08)

### 🚀 新功能

- **动态算法阈值配置**：在前端"高级设置"中开放了对 `algorithm_switch_threshold`（宏观/微观扫描切换阈值）的动态配置功能，允许用户根据需求在效率与精度之间进行微调。
  - 支持范围：20-100 字符
  - 默认值：35 字符
  - 实时验证：防止配置导致的死循环

- **扫描耗时记录**：在扫描完成时，系统现在会自动记录并输出本次扫描的总耗时。
  - 精确计时：从扫描开始到完成的完整耗时统计
  - 友好格式：支持秒级（如 3.45s）和分钟级（如 2m 57s）的自适应显示
  - 日志记录：耗时信息同时输出到系统日志，便于性能分析和监控

### ✨ 优化与改进

#### 核心参数统一管理
- **单一数据源**：将 `algorithm_switch_threshold` 的默认值全局统一为 `35`
  - `config/algorithm/default.json`：35
  - `config/settings/default.json`：35
  - `backend/core/constants.py`：从配置读取，后备值 35
  - `frontend/src/stores/rootStore.js`：默认 35
- **消除硬编码**：所有模块均从配置文件读取该阈值，实现了真正的单一数据源管理
- **向后兼容**：旧的常量 `HYBRID_HANDOVER_THRESHOLD` 和 `MICRO_SCAN_THRESHOLD` 保留为别名，确保旧代码逻辑不受影响

#### 前端体验与安全增强
- **死循环防护**：在高级设置界面加入了安全校验
  - 实时检验：`algorithm_switch_threshold > 2 × overlap_size`
  - 视觉反馈：显示当前值是否满足安全条件（✓ 安全 / ✗ 危险）
  - 操作保护：当验证失败时，禁用保存按钮并显示明确的警告提示
- **界面简化**：为提升用户体验，UI 上隐藏了低频参数（但后端与文档仍保留）
  - 隐藏参数：`jitter`、`token_limit`、`delimiter`、`min_granularity`
  - 保留能力：用户仍可通过编辑 JSON 配置文件来修改这些参数
- **参数联动**：前端加载/保存时自动处理参数合并，确保运行时覆盖生效

#### 代码架构优化
- **常量来源统一**：不再在多个地方硬编码 35
  - `BinarySearcher`：从 `algorithm_config` 读取阈值
  - `TextScanner`：合并 settings 中的 `algorithm_switch_threshold` 到 algorithm 配置
  - `HybridScanStrategy`：使用 `algorithm_config` 中的值或默认值
- **配置优先级**：运行时读取优先级为
  1. `settings.user.json` > 2. `settings.default.json` > 3. `constants` 后备值

---

## 1.0.1 (2025-12-07)

### ✨ 优化与修复

- **优化**：改进了"检测结果"弹窗的用户体验。
  - **分页功能**：为"完整检测结果"弹窗中的表格添加了分页功能，默认每页显示 10 条，并支持切换每页条数（10/20/50/100）。
  - **序号修正**：修复了分页后序号不连续的问题，现在序号会根据页码和每页条数动态计算。
  - **自动重置**：在进行关键词搜索或结果列表更新时，表格会自动重置到第一页，提升了操作的流畅性。


## 1.0.0 (2025-12-07)

**首次公开发布**

这是项目的第一个稳定版本，包含了完整的核心功能与标准化的文档。

### 核心功能

#### 🔍 扫描引擎
- **混合扫描算法**：自适应长/短文本处理，自动在二分查找和精确扫描之间切换
  - 短文本：使用精确扫描，确保 100% 精度
  - 长文本：使用二分查找，显著提升扫描速度
  - 自动切换阈值：根据文本长度智能选择算法
- **高效的二分查找**：采用重叠安全区设计，防止敏感词被分割
- **精确定位**：支持字符级别的敏感词定位（最小粒度可设为 1）

#### 🚀 性能优化
- **智能缓存机制**：实现"发现一次，全局屏蔽"策略，减少重复 API 调用
- **并发控制**：可配置的并发数（1-50），适应不同网络环境
- **自动重试机制**：支持指数退避和随机抖动，提高网络不稳定环境下的成功率
- **Token 优化**：智能分块处理，避免超出模型上下文限制

#### 🎨 用户界面
- **Vue 3 前端**：现代化的响应式界面，支持深色/浅色主题
- **实时反馈**：通过 WebSocket 实时推送扫描进度、日志与结果
- **文件拖拽**：支持直接拖拽文件进行扫描
- **结果导出**：支持导出扫描结果为 JSON 格式
- **预设管理**：内置多个预设方案，支持自定义预设

#### ⚙️ 配置系统
- **多层级配置**：系统默认 → 用户设置 → 预设 → 运行时覆盖
- **灵活的预设方案**：
  - `relay`：中转 API 预设（推荐）
  - `official`：官方 API 预设
  - `custom`：自定义预设
- **无需重启**：配置修改即时生效
- **敏感信息管理**：API 密钥单独存储，支持多个 API 配置

#### 🔧 后端架构
- **FastAPI 框架**：高性能异步 API 服务
- **模块化设计**：清晰的代码结构，易于扩展
- **完整的错误处理**：详细的日志和错误提示
- **WebSocket 支持**：实时双向通信，支持自动重连

### 技术亮点

- **内存高效**：流式处理大文件，避免一次性加载到内存
- **网络容错**：多重重试机制和超时控制，适应复杂网络环境
- **可观测性**：详细的日志记录和实时进度反馈
- **跨平台支持**：Windows/Linux/macOS 多平台支持
